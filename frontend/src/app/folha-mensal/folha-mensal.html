<div class="folha-mensal-container">
  <div class="header">
    <h1>Folha Mensal</h1>
    <div class="header-controls">
      <mat-form-field appearance="outline" class="mes-selector">
        <mat-label>Mês/Ano</mat-label>
        <mat-select [(value)]="mesAnoSelecionado" (selectionChange)="onMesAnoChange()">
          <mat-option *ngFor="let mesAno of mesesDisponiveis" [value]="mesAno.value">
            {{ mesAno.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>
      
      <mat-form-field appearance="outline" class="conta-selector">
        <mat-label>Conta</mat-label>
        <mat-select [(value)]="contaSelecionada" (selectionChange)="onContaChange()">
          <mat-option *ngFor="let conta of contas" [value]="conta.id">
            {{ conta.nome }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <mat-spinner></mat-spinner>
    <p>Carregando folha mensal...</p>
  </div>

  <!-- Error State -->
  <div class="error-container" *ngIf="error && !isLoading">
    <mat-icon class="error-icon">error</mat-icon>
    <h3>Erro ao carregar dados</h3>
    <p>{{ error }}</p>
    <button mat-raised-button color="primary" (click)="carregarFolhaMensal()">
      Tentar Novamente
    </button>
  </div>

  <!-- Main Content -->
  <div class="folha-content" *ngIf="!isLoading && !error && folhaAtual">
    <!-- Resumo da Folha -->
    <div class="resumo-section">
      <mat-card class="resumo-card">
        <mat-card-header>
          <mat-card-title>Resumo - {{ formatMesAno(mesAnoSelecionado) }}</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="resumo-table">
            <div class="resumo-header">
              <div class="item-label"></div>
              <div class="valor-header">Provisionado</div>
              <div class="valor-header">Real</div>
              <div class="valor-header">Diferença</div>
            </div>
            
            <div class="resumo-row">
              <div class="item-label">Saldo Inicial</div>
              <div class="valor">{{ saldoInicial | currency:'BRL':'symbol':'1.2-2' }}</div>
              <div class="valor">{{ saldoInicial | currency:'BRL':'symbol':'1.2-2' }}</div>
              <div class="valor">R$ 0,00</div>
            </div>
            
            <div class="resumo-row receitas">
              <div class="item-label">Receitas</div>
              <div class="valor positive">{{ totalReceitasProvisionadas | currency:'BRL':'symbol':'1.2-2' }}</div>
              <div class="valor positive">{{ totalReceitas | currency:'BRL':'symbol':'1.2-2' }}</div>
              <div class="valor" [ngClass]="{'positive': (totalReceitas - totalReceitasProvisionadas) >= 0, 'negative': (totalReceitas - totalReceitasProvisionadas) < 0}">
                {{ (totalReceitas - totalReceitasProvisionadas) | currency:'BRL':'symbol':'1.2-2' }}
              </div>
            </div>
            
            <div class="resumo-row despesas">
              <div class="item-label">Despesas</div>
              <div class="valor negative">{{ totalDespesasProvisionadas | currency:'BRL':'symbol':'1.2-2' }}</div>
              <div class="valor negative">{{ totalDespesas | currency:'BRL':'symbol':'1.2-2' }}</div>
              <div class="valor" [ngClass]="{'positive': (totalDespesasProvisionadas - totalDespesas) >= 0, 'negative': (totalDespesasProvisionadas - totalDespesas) < 0}">
                {{ (totalDespesasProvisionadas - totalDespesas) | currency:'BRL':'symbol':'1.2-2' }}
              </div>
            </div>
            
            <div class="resumo-row total">
              <div class="item-label"><strong>Saldo Final</strong></div>
              <div class="valor" [ngClass]="{'positive': (saldoInicial + totalReceitasProvisionadas - totalDespesasProvisionadas) >= 0, 'negative': (saldoInicial + totalReceitasProvisionadas - totalDespesasProvisionadas) < 0}">
                <strong>{{ (saldoInicial + totalReceitasProvisionadas - totalDespesasProvisionadas) | currency:'BRL':'symbol':'1.2-2' }}</strong>
              </div>
              <div class="valor" [ngClass]="{'positive': saldoFinal >= 0, 'negative': saldoFinal < 0}">
                <strong>{{ saldoFinal | currency:'BRL':'symbol':'1.2-2' }}</strong>
              </div>
              <div class="valor" [ngClass]="{'positive': (saldoFinal - (saldoInicial + totalReceitasProvisionadas - totalDespesasProvisionadas)) >= 0, 'negative': (saldoFinal - (saldoInicial + totalReceitasProvisionadas - totalDespesasProvisionadas)) < 0}">
                <strong>{{ (saldoFinal - (saldoInicial + totalReceitasProvisionadas - totalDespesasProvisionadas)) | currency:'BRL':'symbol':'1.2-2' }}</strong>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Filtros -->
    <div class="filtros-section">
      <mat-button-toggle-group [(value)]="filtroTipo">
        <mat-button-toggle value="todos">Todos</mat-button-toggle>
        <mat-button-toggle value="receitas">Receitas</mat-button-toggle>
        <mat-button-toggle value="despesas">Despesas</mat-button-toggle>
      </mat-button-toggle-group>
      
      <button mat-raised-button color="primary">
        <mat-icon>add</mat-icon>
        Novo Lançamento
      </button>
    </div>

    <!-- Planilha de Lançamentos -->
    <div class="lancamentos-section">
      <!-- Lançamentos por Categoria -->
      <mat-card class="lancamentos-card categoria-card" *ngIf="categoriasAgrupadas.length > 0">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>category</mat-icon>
            Lançamentos por Categoria
          </mat-card-title>
          <mat-card-subtitle>{{ getTotalLancamentosCategorias() }} lançamento(s) organizados</mat-card-subtitle>
        </mat-card-header>
        
        <mat-card-content>
          <div class="modern-table-container">
            <!-- Cabeçalho Moderno -->
            <div class="table-header">
              <div class="header-cell col-descricao">
                <mat-icon>description</mat-icon>
                <span>Descrição</span>
              </div>
              <div class="header-cell col-tipo">
                <mat-icon>swap_vert</mat-icon>
                <span>Tipo</span>
              </div>
              <div class="header-cell col-data">
                <mat-icon>event</mat-icon>
                <span>Data</span>
              </div>
              <div class="header-cell col-valor">
                <mat-icon>account_balance_wallet</mat-icon>
                <span>Provisionado</span>
              </div>
              <div class="header-cell col-valor">
                <mat-icon>payments</mat-icon>
                <span>Valor Real</span>
              </div>
              <div class="header-cell col-status">
                <mat-icon>info</mat-icon>
                <span>Status</span>
              </div>
              <div class="header-cell col-acoes">
                <mat-icon>settings</mat-icon>
                <span>Ações</span>
              </div>
            </div>

            <!-- Corpo da Tabela -->
            <div class="table-body">
              <!-- Grupos por Categoria -->
              <div class="categoria-group" *ngFor="let categoria of categoriasAgrupadas; trackBy: trackByCategoria">
                <!-- Cabeçalho da Categoria -->
                <div class="categoria-header" [class.expanded]="categoria.expanded" (click)="toggleCategoria(categoria)">
                  <div class="categoria-info">
                    <mat-icon class="expand-icon" [class.rotated]="categoria.expanded">expand_more</mat-icon>
                    <h4>{{ categoria.nome }}</h4>
                    <span class="categoria-resumo">{{ categoria.lancamentos.length }} lançamento(s)</span>
                  </div>
                  <div class="categoria-valores">
                    <span class="valor-provisionado">Prov: {{ categoria.valorProvisionado | currency:'BRL':'symbol':'1.2-2' }}</span>
                    <span class="valor-real">Real: {{ categoria.valorReal | currency:'BRL':'symbol':'1.2-2' }}</span>
                    <span class="diferenca" [ngClass]="{'positive': categoria.diferenca >= 0, 'negative': categoria.diferenca < 0}">
                      Dif: {{ categoria.diferenca | currency:'BRL':'symbol':'1.2-2' }}
                    </span>
                  </div>
                </div>

              <!-- Lançamentos da Categoria (Expansível) -->
              <div class="lancamentos-container" *ngIf="categoria.expanded">
                <div class="transaction-row" *ngFor="let lancamento of categoria.lancamentos; trackBy: trackByLancamento"
                     [ngClass]="{
                       'realizado': lancamento.realizado,
                       'pendente': !lancamento.realizado && !lancamento.cancelado,
                       'cancelado': lancamento.cancelado,
                       'receita': lancamento.tipo === 1,
                       'despesa': lancamento.tipo === 2
                     }">
                  
                  <div class="cell col-descricao">
                    {{ lancamento.descricao }}
                  </div>
                  
                  <div class="cell col-tipo">
                    <span class="tipo-badge" [ngClass]="{'receita': lancamento.tipo === 1, 'despesa': lancamento.tipo === 2}">
                      {{ getTipoLancamentoText(lancamento.tipo) }}
                    </span>
                  </div>
                  
                  <div class="cell col-data">
                    {{ getFormattedDate(lancamento.dataInicial) }}
                  </div>
                  
                  <div class="cell col-valor" [ngClass]="{'receita': lancamento.tipo === 1, 'despesa': lancamento.tipo === 2}">
                    {{ (lancamento.valorProvisionado || lancamento.valor) | currency:'BRL':'symbol':'1.2-2' }}
                  </div>
                  
                  <div class="cell col-valor" [ngClass]="{'receita': lancamento.tipo === 1, 'despesa': lancamento.tipo === 2}">
                    <span *ngIf="lancamento.realizado">{{ lancamento.valor | currency:'BRL':'symbol':'1.2-2' }}</span>
                    <span *ngIf="!lancamento.realizado" class="valor-pendente">Não realizado</span>
                  </div>
                  
                  <div class="cell col-status">
                    <span class="status-chip" [ngClass]="{
                      'realizado': lancamento.realizado,
                      'pendente': !lancamento.realizado && !lancamento.cancelado,
                      'cancelado': lancamento.cancelado
                    }">
                      {{ getStatusText(lancamento) }}
                    </span>
                  </div>
                  
                  <div class="cell col-acoes">
                    <button mat-mini-fab color="primary" 
                            *ngIf="!lancamento.realizado && !lancamento.cancelado" 
                            (click)="abrirModalRealizarLancamento(lancamento)"
                            matTooltip="Realizar Lançamento">
                      <mat-icon>check</mat-icon>
                    </button>
                    <button mat-mini-fab 
                            (click)="editarLancamento(lancamento)"
                            matTooltip="Editar Lançamento">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-mini-fab color="warn"
                            *ngIf="!lancamento.cancelado"
                            (click)="cancelarLancamento(lancamento)"
                            matTooltip="Cancelar Lançamento">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                </div>
                </div>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Lançamentos Esporádicos -->
      <mat-card class="lancamentos-card esporadicos-card" *ngIf="lancamentosEsporadicos.length > 0">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>flash_on</mat-icon>
            Lançamentos Esporádicos
          </mat-card-title>
          <mat-card-subtitle>{{ lancamentosEsporadicos.length }} lançamento(s) sem categoria</mat-card-subtitle>
        </mat-card-header>
        
        <mat-card-content>
          <div class="esporadicos-container">
            <div class="lancamento-esporadico" *ngFor="let lancamento of lancamentosEsporadicos; trackBy: trackByLancamento"
                 [ngClass]="{
                   'realizado': lancamento.realizado,
                   'pendente': !lancamento.realizado && !lancamento.cancelado,
                   'cancelado': lancamento.cancelado,
                   'receita': lancamento.tipo === 1,
                   'despesa': lancamento.tipo === 2
                 }">
              
              <div class="esporadico-main">
                <div class="esporadico-info">
                  <div class="tipo-badge-small" [ngClass]="{'receita': lancamento.tipo === 1, 'despesa': lancamento.tipo === 2}">
                    <mat-icon>{{ lancamento.tipo === 1 ? 'trending_up' : 'trending_down' }}</mat-icon>
                  </div>
                  <div class="lancamento-details">
                    <h4>{{ lancamento.descricao }}</h4>
                    <div class="meta-info">
                      <span class="data-info">
                        <mat-icon>event</mat-icon>
                        {{ getFormattedDate(lancamento.dataInicial) }}
                      </span>
                      <span class="tipo-info">{{ getTipoLancamentoText(lancamento.tipo) }}</span>
                    </div>
                  </div>
                </div>
                
                <div class="esporadico-valores">
                  <div class="valor-provisionado">
                    <span class="label">Provisionado</span>
                    <span class="amount">{{ (lancamento.valorProvisionado || lancamento.valor) | currency:'BRL':'symbol':'1.2-2' }}</span>
                  </div>
                  <div class="valor-real" *ngIf="lancamento.realizado">
                    <span class="label">Realizado</span>
                    <span class="amount">{{ lancamento.valor | currency:'BRL':'symbol':'1.2-2' }}</span>
                  </div>
                  <div class="valor-pendente" *ngIf="!lancamento.realizado">
                    <span class="label">Status</span>
                    <span class="status">Pendente</span>
                  </div>
                </div>
                
                <div class="esporadico-acoes">
                  <button mat-mini-fab color="primary" 
                          *ngIf="!lancamento.realizado && !lancamento.cancelado" 
                          (click)="abrirModalRealizarLancamento(lancamento)"
                          matTooltip="Realizar Lançamento">
                    <mat-icon>check</mat-icon>
                  </button>
                  <button mat-mini-fab 
                          (click)="editarLancamento(lancamento)"
                          matTooltip="Editar Lançamento">
                    <mat-icon>edit</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Estado Vazio Melhorado -->
      <div class="empty-state-modern" *ngIf="categoriasAgrupadas.length === 0 && lancamentosEsporadicos.length === 0">
        <div class="empty-content">
          <mat-icon class="empty-icon">receipt_long</mat-icon>
          <h2>Nenhum lançamento encontrado</h2>
          <p>Esta folha mensal ainda não possui lançamentos. Comece criando categorias e lançamentos para organizar suas finanças.</p>
          <div class="empty-actions">
            <button mat-raised-button color="primary" (click)="criarNovoLancamento()">
              <mat-icon>add</mat-icon>
              Criar Primeiro Lançamento
            </button>
            <button mat-stroked-button (click)="gerenciarCategorias()">
              <mat-icon>category</mat-icon>
              Gerenciar Categorias
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Realizar Lançamento -->
<div class="modal-overlay" *ngIf="showRealizarModal" (click)="fecharModalRealizar()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>
        <mat-icon>check_circle</mat-icon>
        Realizar Lançamento
      </h2>
      <button mat-icon-button (click)="fecharModalRealizar()" class="close-button">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    
    <div class="modal-content" *ngIf="lancamentoSelecionado">
      <div class="lancamento-info">
        <div class="info-item">
          <span class="label">Descrição:</span>
          <span class="value">{{ lancamentoSelecionado.descricao }}</span>
        </div>
        <div class="info-item">
          <span class="label">Valor Provisionado:</span>
          <span class="value">{{ (lancamentoSelecionado.valorProvisionado || lancamentoSelecionado.valor) | currency:'BRL':'symbol':'1.2-2' }}</span>
        </div>
        <div class="info-item">
          <span class="label">Data:</span>
          <span class="value">{{ getFormattedDate(lancamentoSelecionado.dataInicial) }}</span>
        </div>
      </div>
      
      <mat-form-field appearance="outline" class="valor-real-field">
        <mat-label>Valor Real *</mat-label>
        <input matInput 
               type="text" 
               [(ngModel)]="valorRealInput"
               (input)="formatarValorReal($event)"
               placeholder="R$ 0,00"
               class="valor-input">
        <mat-icon matPrefix>payments</mat-icon>
        <mat-hint>Digite o valor real do lançamento</mat-hint>
      </mat-form-field>
      
      <div class="diferenca-display" *ngIf="valorRealNumerico !== null">
        <div class="diferenca-item" [ngClass]="{'positive': getDiferenca() >= 0, 'negative': getDiferenca() < 0}">
          <span class="diferenca-label">Diferença:</span>
          <span class="diferenca-valor">{{ getDiferenca() | currency:'BRL':'symbol':'1.2-2' }}</span>
        </div>
      </div>
    </div>
    
    <div class="modal-actions">
      <button mat-stroked-button (click)="fecharModalRealizar()">
        <mat-icon>cancel</mat-icon>
        Cancelar
      </button>
      <button mat-raised-button color="primary" 
              (click)="confirmarRealizacao()"
              [disabled]="!valorRealInput || valorRealNumerico === null">
        <mat-icon>check</mat-icon>
        Realizar Lançamento
      </button>
    </div>
  </div>
</div>
