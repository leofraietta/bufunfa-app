<div class="folha-mensal-container">
  <div class="header">
    <h1>Folha Mensal</h1>
    <div class="header-controls">
      <mat-form-field appearance="outline" class="mes-selector">
        <mat-label>Mês/Ano</mat-label>
        <mat-select [(value)]="mesAnoSelecionado" (selectionChange)="onMesAnoChange()">
          <mat-option *ngFor="let mesAno of mesesDisponiveis" [value]="mesAno.value">
            {{ mesAno.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>
      
      <mat-form-field appearance="outline" class="conta-selector">
        <mat-label>Conta</mat-label>
        <mat-select [(value)]="contaSelecionada" (selectionChange)="onContaChange()">
          <mat-option *ngFor="let conta of contas" [value]="conta.id">
            {{ conta.nome }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <mat-spinner></mat-spinner>
    <p>Carregando folha mensal...</p>
  </div>

  <!-- Error State -->
  <div class="error-container" *ngIf="error && !isLoading">
    <mat-icon class="error-icon">error</mat-icon>
    <h3>Erro ao carregar dados</h3>
    <p>{{ error }}</p>
    <button mat-raised-button color="primary" (click)="carregarFolhaMensal()">
      Tentar Novamente
    </button>
  </div>

  <!-- Main Content -->
  <div class="folha-content" *ngIf="!isLoading && !error && folhaAtual">
    <!-- Resumo da Folha -->
    <div class="resumo-section">
      <mat-card class="resumo-card">
        <mat-card-header>
          <mat-card-title>Resumo - {{ formatMesAno(mesAnoSelecionado) }}</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="resumo-table">
            <div class="resumo-header">
              <div class="item-label"></div>
              <div class="valor-header">Provisionado</div>
              <div class="valor-header">Real</div>
              <div class="valor-header">Diferença</div>
            </div>
            
            <div class="resumo-row">
              <div class="item-label">Saldo Inicial</div>
              <div class="valor">{{ saldoInicial | currency:'BRL':'symbol':'1.2-2' }}</div>
              <div class="valor">{{ saldoInicial | currency:'BRL':'symbol':'1.2-2' }}</div>
              <div class="valor">R$ 0,00</div>
            </div>
            
            <div class="resumo-row receitas">
              <div class="item-label">Receitas</div>
              <div class="valor positive">{{ totalReceitasProvisionadas | currency:'BRL':'symbol':'1.2-2' }}</div>
              <div class="valor positive">{{ totalReceitas | currency:'BRL':'symbol':'1.2-2' }}</div>
              <div class="valor" [ngClass]="{'positive': (totalReceitas - totalReceitasProvisionadas) >= 0, 'negative': (totalReceitas - totalReceitasProvisionadas) < 0}">
                {{ (totalReceitas - totalReceitasProvisionadas) | currency:'BRL':'symbol':'1.2-2' }}
              </div>
            </div>
            
            <div class="resumo-row despesas">
              <div class="item-label">Despesas</div>
              <div class="valor negative">{{ totalDespesasProvisionadas | currency:'BRL':'symbol':'1.2-2' }}</div>
              <div class="valor negative">{{ totalDespesas | currency:'BRL':'symbol':'1.2-2' }}</div>
              <div class="valor" [ngClass]="{'positive': (totalDespesasProvisionadas - totalDespesas) >= 0, 'negative': (totalDespesasProvisionadas - totalDespesas) < 0}">
                {{ (totalDespesasProvisionadas - totalDespesas) | currency:'BRL':'symbol':'1.2-2' }}
              </div>
            </div>
            
            <div class="resumo-row total">
              <div class="item-label"><strong>Saldo Final</strong></div>
              <div class="valor" [ngClass]="{'positive': (saldoInicial + totalReceitasProvisionadas - totalDespesasProvisionadas) >= 0, 'negative': (saldoInicial + totalReceitasProvisionadas - totalDespesasProvisionadas) < 0}">
                <strong>{{ (saldoInicial + totalReceitasProvisionadas - totalDespesasProvisionadas) | currency:'BRL':'symbol':'1.2-2' }}</strong>
              </div>
              <div class="valor" [ngClass]="{'positive': saldoFinal >= 0, 'negative': saldoFinal < 0}">
                <strong>{{ saldoFinal | currency:'BRL':'symbol':'1.2-2' }}</strong>
              </div>
              <div class="valor" [ngClass]="{'positive': (saldoFinal - (saldoInicial + totalReceitasProvisionadas - totalDespesasProvisionadas)) >= 0, 'negative': (saldoFinal - (saldoInicial + totalReceitasProvisionadas - totalDespesasProvisionadas)) < 0}">
                <strong>{{ (saldoFinal - (saldoInicial + totalReceitasProvisionadas - totalDespesasProvisionadas)) | currency:'BRL':'symbol':'1.2-2' }}</strong>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Filtros -->
    <div class="filtros-section">
      <mat-button-toggle-group [(value)]="filtroTipo">
        <mat-button-toggle value="todos">Todos</mat-button-toggle>
        <mat-button-toggle value="receitas">Receitas</mat-button-toggle>
        <mat-button-toggle value="despesas">Despesas</mat-button-toggle>
      </mat-button-toggle-group>
      
      <button mat-raised-button color="primary">
        <mat-icon>add</mat-icon>
        Novo Lançamento
      </button>
    </div>

    <!-- Planilha de Lançamentos -->
    <div class="lancamentos-section">
      <mat-card class="lancamentos-card">
        <mat-card-header>
          <mat-card-title>Lançamentos por Categoria</mat-card-title>
        </mat-card-header>
        
        <mat-card-content>
          <div class="spreadsheet-container">
            <!-- Cabeçalho da Planilha -->
            <div class="spreadsheet-header">
              <div class="col-descricao">Descrição</div>
              <div class="col-tipo">Tipo</div>
              <div class="col-data">Data</div>
              <div class="col-valor">Provisionado</div>
              <div class="col-valor">Real</div>
              <div class="col-status">Status</div>
              <div class="col-acoes">Ações</div>
            </div>

            <!-- Grupos por Categoria -->
            <div class="categoria-group" *ngFor="let categoria of categoriasAgrupadas">
              <!-- Cabeçalho da Categoria -->
              <div class="categoria-header">
                <div class="categoria-info">
                  <h4>{{ categoria.nome }}</h4>
                  <span class="categoria-resumo">
                    {{ categoria.lancamentos.length }} lançamento(s)
                  </span>
                </div>
                <div class="categoria-valores">
                  <span class="valor-provisionado">{{ categoria.valorProvisionado | currency:'BRL':'symbol':'1.2-2' }}</span>
                  <span class="valor-real">{{ categoria.valorReal | currency:'BRL':'symbol':'1.2-2' }}</span>
                  <span class="diferenca" [ngClass]="{'positive': categoria.diferenca >= 0, 'negative': categoria.diferenca < 0}">
                    {{ categoria.diferenca | currency:'BRL':'symbol':'1.2-2' }}
                  </span>
                </div>
              </div>

              <!-- Lançamentos da Categoria -->
              <div class="lancamento-row" *ngFor="let lancamento of categoria.lancamentos"
                   [ngClass]="{'realizado': lancamento.realizado, 'pendente': !lancamento.realizado}">
                
                <div class="col-descricao">
                  <span class="descricao">{{ lancamento.descricao }}</span>
                  <span class="recorrencia" *ngIf="lancamento.tipoRecorrencia !== 1">
                    {{ getTipoRecorrenciaText(lancamento.tipoRecorrencia) }}
                  </span>
                </div>
                
                <div class="col-tipo">
                  <mat-icon class="tipo-icon" [ngClass]="{'receita': lancamento.tipo === 1, 'despesa': lancamento.tipo === 2}">
                    {{ lancamento.tipo === 1 ? 'trending_up' : 'trending_down' }}
                  </mat-icon>
                  <span>{{ getTipoLancamentoText(lancamento.tipo) }}</span>
                </div>
                
                <div class="col-data">
                  {{ lancamento.dataInicial | date:'dd/MM/yyyy' }}
                </div>
                
                <div class="col-valor">
                  <span class="valor" [ngClass]="{'receita': lancamento.tipo === 1, 'despesa': lancamento.tipo === 2}">
                    {{ (lancamento.valorProvisionado || lancamento.valor) | currency:'BRL':'symbol':'1.2-2' }}
                  </span>
                </div>
                
                <div class="col-valor">
                  <span class="valor" *ngIf="lancamento.realizado" [ngClass]="{'receita': lancamento.tipo === 1, 'despesa': lancamento.tipo === 2}">
                    {{ lancamento.valor | currency:'BRL':'symbol':'1.2-2' }}
                  </span>
                  <span class="valor-pendente" *ngIf="!lancamento.realizado">-</span>
                </div>
                
                <div class="col-status">
                  <div class="status-badge" [ngClass]="{'realizado': lancamento.realizado, 'pendente': !lancamento.realizado, 'cancelado': lancamento.cancelado}">
                    <mat-icon class="status-icon">
                      {{ lancamento.realizado ? 'check_circle' : (lancamento.cancelado ? 'cancel' : 'schedule') }}
                    </mat-icon>
                    <span>{{ lancamento.realizado ? 'Realizado' : (lancamento.cancelado ? 'Cancelado' : 'Pendente') }}</span>
                  </div>
                </div>
                
                <div class="col-acoes">
                  <button mat-icon-button *ngIf="!lancamento.realizado && !lancamento.cancelado" 
                          (click)="realizarLancamento(lancamento)"
                          matTooltip="Realizar Lançamento">
                    <mat-icon>check</mat-icon>
                  </button>
                  <button mat-icon-button (click)="editarLancamento(lancamento)"
                          matTooltip="Editar Lançamento">
                    <mat-icon>edit</mat-icon>
                  </button>
                </div>
              </div>
            </div>

            <!-- Estado Vazio -->
            <div class="empty-state" *ngIf="categoriasAgrupadas.length === 0">
              <mat-icon class="empty-icon">receipt_long</mat-icon>
              <h3>Nenhum lançamento encontrado</h3>
              <p>Não há lançamentos para este mês. Crie seu primeiro lançamento para começar.</p>
              <button mat-raised-button color="primary">
                <mat-icon>add</mat-icon>
                Criar Lançamento
              </button>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
